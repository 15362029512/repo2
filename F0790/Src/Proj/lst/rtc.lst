C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE RTC
OBJECT MODULE PLACED IN .\output\rtc.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\User\Src\rtc.c LARGE OMF2 OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Core;..\
                    -Lib\Inc;..\User\Inc;..\App\Inc) DEBUG PRINT(.\lst\rtc.lst) OBJECT(.\output\rtc.obj)

line level    source

   1          /* Includes ------------------------------------------------------------------*/
   2          #include "rtc.h"
   3          /* Private typedef -----------------------------------------------------------*/
   4          
   5          
   6          /* Private define ------------------------------------------------------------*/
   7          
   8          
   9          /* Private variables ---------------------------------------------------------*/
  10          /* Private function prototypes -----------------------------------------------*/
  11          /* Private functions ---------------------------------------------------------*/
  12          
  13          
  14          /* global variables ----------------------------------------------------------*/
  15          
  16          uint8_t flag_minute = 0;
  17          uint8_t flag_second = 0;
  18          
  19          code uint8_t day_of_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};                    
  20          code uint8_t table_week[]        = {0,3,3,6,1,4,6,2,5,0,3,5};                                                   //ÔÂÐÞÕýÊý¾Ý±í   
  21          
  22                          
  23          _CALENDAR                       calendar = {2018,1,1,12,0,0};                                                                           //2018-1-1 12:0:0       ;                                                                                               
  24          #define year            calendar.st_year
  25          #define month           calendar.st_month
  26          #define day                     calendar.st_day
  27          #define hour            calendar.st_hour
  28          #define minute      calendar.st_minute
  29          #define second      calendar.st_second
  30          #define week            calendar.st_week
  31          
  32          _ALARM          rtc_alarm[ALARM_CNT] = 
  33                                                          {
  34                                                                  day_1_7,7,0,0,
  35                                                                  day_1_7,7,0,0,
  36                                                          };
  37          
  38          uint8_t                 flag_current_alarmed;                           //µ±Ç°ÄÖÁåµÄÊÇÄÄÒ»¸öÄÖÖÓ
  39          uint8_t                 flag_current_seting_alarm;      //µ±Ç°ÉèÖÃµÄÊÇÄÄÒ»¸öÄÖÖÓ
  40          
  41          uint8_t                 flag_24hours_en = 1;                            //1£ºÊ±ÖÓ24Ð¡Ê±ÖÆ
  42          uint8_t                 flag_alarm1_en = 0;                                     //1£ºÄÖÖÓ1¿ªÆô
  43          uint8_t                 flag_alarm2_en = 0;                                     //1£ºÄÖÖÓ2¿ªÆô                                          
  44                                                          
  45          uint8_t                 flag_alarm_style_ring = 0;      //1£ºÄÖÖÓÏìÁå·½Ê½£ºÉùÒô¿ª
  46          uint8_t                 flag_alarm_style_shake = 0;     //1£ºÄÖÖÓÏìÁå·½Ê½£ºÕð¶¯¿ª
  47          
  48          #ifdef SHOW_ALARM_TIME_EN
              uint8_t                 flag_show_which_alarm;                  //³ÖÐøÏÔÊ¾ÄÄ¸öÄÖÖÓµÄÊ±¼ä5Ãë
              #endif
  51          
  52          uint16_t                flag_enter_snooze = 0;                  //flag_sleep_again = 0;                                         //1£º½øÈëÌ°Ë¯
  53          
  54          uint8_t                 flag_current_snooze = 0;                //µ±Ç°Ì°Ë¯µÄÊÇÄÄÒ»¸öÄÖÖÓ   
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 2   

  55          uint8_t                 snooze_time = 9;                                                //Ì°Ë¯Ê±³¤              µ¥Î»£º·ÖÖÓ
  56          
  57          uint8_t                 flag_alarm_timeout = 0;                 //1£ºÄÖÖÓÊ±¼äµ½£¬ÄÖÁåÏì 
  58          
  59          uint16_t        alarmed_time = 0;                                               //ÄÖÖÓÏìÁå¾­¹ýµÄÊ±¼ä
  60          uint8_t         alarm_ring_step = 0;                            //
  61          uint8_t         alarm_shake_step = 0;
  62          /*********************************************************************************************************
             -************/
  63          
  64          /*********************************************************************************************************
             -************/
  65          
  66          
  67          
  68          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
  69          /***@º¯ÊýÃû³Æ£º   updata_calendar
  70              @º¯Êý¹¦ÄÜ£º   ¸üÐÂÈÕÀú
  71              @Èë¿Ú²ÎÊý£º   ÎÞ
  72              @³ö¿Ú²ÎÊý£º   ÎÞ
  73              @±¸×¢ËµÃ÷£º   ÎÞ
  74          */
  75          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
  76          
  77          void updata_calendar(void)
  78          {
  79   1              set_rtc(calendar.st_year,
  80   1                                              calendar.st_month,
  81   1                                              calendar.st_day,
  82   1                                              calendar.st_hour,
  83   1                                              calendar.st_minute,
  84   1                                              calendar.st_second);
  85   1              get_calendar();
  86   1      }
  87          
  88                                          
  89          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
  90          /***@º¯ÊýÃû³Æ£º   rtc_init
  91              @º¯Êý¹¦ÄÜ£º   RTC³õÊ¼»¯
  92              @Èë¿Ú²ÎÊý£º   ÎÞ
  93              @³ö¿Ú²ÎÊý£º   ÎÞ
  94              @±¸×¢ËµÃ÷£º   ÎÞ
  95          */
  96          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
  97          void rtc_init(void)
  98          {
  99   1      
 100   1              
 101   1              
 102   1              RTCON = 0xa2;                                                                           //RTCÊ±ÖÓÊ¹ÄÜ£¬ºÁÃëÖÐ¶Ï¹Ø±Õ£¬°ëÃëÖÐ¶ÏÊ¹ÄÜ£¬Ê±ÖÓÐ´Ê¹ÄÜ
 103   1      //      RTCIF = 0XFF;
 104   1      //      RTMSS = 0;                                                                                      //3.9ms  Ä¬ÈÏ
 105   1              Delay_50us(10);                                                                 //RTCÊ¹ÄÜºó±ØÐëÑÓÊ±300usÔÙÐ´ÈëÊ±¼ä£¬ ·ñÔòÐ´ÈëÊ±¼ä¿ÉÄÜÎÞÐ§¡£
 106   1      
 107   1              updata_calendar();                                                      
 108   1              INT8EN = 1;                                                                                     //¿ªÆôRTCÖÐ¶Ï           
 109   1      }
 110          
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 3   

 111          
 112          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 113          /***@º¯ÊýÃû³Æ£º   is_leap_year
 114              @º¯Êý¹¦ÄÜ£º   ÅÐ¶ÏÊÇÆ½Äê»¹ÊÇÈòÄê
 115              @Èë¿Ú²ÎÊý£º   ÎÞ
 116              @³ö¿Ú²ÎÊý£º   ÎÞ
 117              @±¸×¢ËµÃ÷£º   ÎÞ
 118          */
 119          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 120          
 121          uint8_t is_leap_year(uint16_t _year)
 122          { 
 123   1              if (_year % 4 == 0) //±ØÐëÄÜ±»4Õû³ý
 124   1              { 
 125   2                      if (_year % 100 == 0) 
 126   2                      { 
 127   3                              if (_year % 400 == 0)
 128   3                  {
 129   4                      return 1;//Èç¹ûÒÔ00½áÎ²,»¹ÒªÄÜ±»400Õû³ý  
 130   4                  }   
 131   3                              else 
 132   3                  {
 133   4                      return 0;   
 134   4                  }
 135   3                      }
 136   2              else 
 137   2              {
 138   3                  return 1;  
 139   3              } 
 140   2              }
 141   1          else
 142   1          {
 143   2              return 0;  
 144   2          } 
 145   1      }
 146          
 147          
 148          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 149          /***@º¯ÊýÃû³Æ£º   is_over_max_days
 150              @º¯Êý¹¦ÄÜ£º   ÅÐ¶ÏÌìÊýÊÇ·ñ³¬³öÔÂ·ÝµÄ×î´óÌìÊýÖµ
 151              @Èë¿Ú²ÎÊý£º   ÎÞ
 152              @³ö¿Ú²ÎÊý£º   ÎÞ
 153              @±¸×¢ËµÃ÷£º   ÎÞ
 154          */
 155          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 156          uint8_t is_over_max_days(uint16_t _year,uint8_t _month,uint8_t _day)
 157          {
 158   1              if (_month == 4 || _month == 6 || _month == 9 || _month == 11)
 159   1              {
 160   2                      if (_day > 30) 
 161   2              {
 162   3                  return 1;
 163   3              }
 164   2                      else
 165   2              {
 166   3                  return 0;
 167   3              }
 168   2              } 
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 4   

 169   1              else if (_month == 2)
 170   1              {
 171   2                      if (is_leap_year(_year))
 172   2                      {
 173   3                              if (_day > 29) 
 174   3                  {
 175   4                      return 1;
 176   4                  }
 177   3                              else 
 178   3                  {
 179   4                      return 0;
 180   4                  }
 181   3                  }
 182   2                      else
 183   2                      {
 184   3                              if (_day > 28)
 185   3                  {
 186   4                      return 1;
 187   4                  }
 188   3                              else 
 189   3                  {
 190   4                      return 0;
 191   4                  }
 192   3                      }
 193   2              }
 194   1              else
 195   1              {
 196   2                      if (_day > 31) 
 197   2              {
 198   3                  return 1;
 199   3              }
 200   2                      else 
 201   2              {
 202   3                  return 0;
 203   3              }
 204   2              }
 205   1      }
 206          
 207          
 208          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 209          /***@º¯ÊýÃû³Æ£º   set_max_days_of_month
 210              @º¯Êý¹¦ÄÜ£º   ÉèÖÃÄ³Ò»¸öÔÂµÄ×î´óÌìÊýÖµ 
 211              @Èë¿Ú²ÎÊý£º   ÎÞ
 212              @³ö¿Ú²ÎÊý£º   ÎÞ
 213              @±¸×¢ËµÃ÷£º   ÎÞ
 214          */
 215          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 216          void set_max_days_of_month(uint16_t _year,uint8_t _month)
 217          {
 218   1              if (_month == 4 || _month == 6 || _month == 9 || _month == 11)
 219   1              {
 220   2                      calendar.st_day = 30;
 221   2              }
 222   1              else if (_month == 2)
 223   1              {
 224   2                      if (is_leap_year(_year))
 225   2                      {
 226   3                              calendar.st_day = 29;
 227   3                      }
 228   2                      else
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 5   

 229   2                      {
 230   3                              calendar.st_day = 28;
 231   3                      }
 232   2              }
 233   1      //      else
 234   1      //      {
 235   1      //              calendar.st_day = 31;
 236   1      //      }       
 237   1      }
 238          
 239          
 240          
 241          
 242          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 243          /***@º¯ÊýÃû³Æ£º   get_calendar
 244              @º¯Êý¹¦ÄÜ£º   »ñÈ¡ÈÕÀúÐÅÏ¢(¶ÁÈ¡RTC¼Ä´æÆ÷ µ½ ±äÁ¿) °üÀ¨ ÄêÔÂÈÕ Ê±·ÖÃë ÐÇÆÚ  
 245              @Èë¿Ú²ÎÊý£º   ÎÞ
 246              @³ö¿Ú²ÎÊý£º   ÎÞ
 247              @±¸×¢ËµÃ÷£º   ÎÞ
 248          */
 249          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 250          void get_calendar(void)
 251          {
 252   1              uint16_t day_remain = 0;
 253   1              uint16_t get_year = 1970;
 254   1              uint8_t  get_month = 0;
 255   1              
 256   1              second = RTCS;          
 257   1              minute = RTCM;
 258   1              hour = RTCH & 0x1f;                                                                                                             //RTCHµÍ5Î»±íÊ¾Ð¡Ê±
 259   1              week = RTCH >> 5;                                                                                                                       //RTCH¸ß3Î»±íÊ¾ÐÇÆÚ
 260   1              day_remain = RTCDH ;
 261   1              day_remain = (day_remain << 8) | RTCDL;                         //»ñÈ¡RTCD¼Ä´æÆ÷ÀïµÄÌìÊýÖµ
 262   1              
 263   1              /***************Ñ­»·ÅÐ¶ÏµÃµ½Äê·Ý********************/
 264   1              while(day_remain >= 365)                        
 265   1              {
 266   2                      if(is_leap_year(get_year))      //Èç¹ûÊÇÈòÄê
 267   2                      {
 268   3                              if(day_remain >= 366)           //ÇÒÌìÊý³¬¹ýÒ»Äê
 269   3                              {
 270   4                      day_remain -= 366;
 271   4                  }                           
 272   3                              else 
 273   3                  {
 274   4                      break;                              //ÌìÊýÎ´³¬¹ýÒ»Äê£¬Ö±½ÓÍË³ö
 275   4                  }
 276   3                      }
 277   2                      else 
 278   2              {
 279   3                  day_remain -= 365;          //Èç¹ûÊÇÆ½ÄêÇÒ³¬¹ýÒ»Äê
 280   3              }               
 281   2                      get_year ++;
 282   2              }       
 283   1              year = get_year;                                                        //µÃµ½Äê                                                                
 284   1              
 285   1              /***************Ñ­»·ÅÐ¶ÏµÃµ½ ÔÂ ÈÕ******************/
 286   1              while(day_remain >= 28)
 287   1              {
 288   2                      if(is_leap_year(year) && get_month == 1)
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 6   

 289   2                      {
 290   3                              if(day_remain >= 29) 
 291   3                  {
 292   4                      day_remain -= 29;
 293   4                  }
 294   3                              else 
 295   3                  {
 296   4                      break;
 297   4                  }
 298   3                      }
 299   2                      else
 300   2                      {
 301   3                              if(day_remain >= day_of_month[get_month]) 
 302   3                  {
 303   4                      day_remain -= day_of_month[get_month];
 304   4                  }
 305   3                              else 
 306   3                  {
 307   4                      break;
 308   4                  }
 309   3                      }
 310   2                      get_month ++;
 311   2              }
 312   1              month = get_month + 1;                  //µÃµ½ÔÂ
 313   1              day = day_remain + 1;                           //µÃµ½ÈÕ
 314   1      }
 315          
 316                                                                                                                                          
 317          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 318          /***@º¯ÊýÃû³Æ£º   get_week
 319              @º¯Êý¹¦ÄÜ£º   ÊäÈë¹«ÀúÈÕÆÚµÃµ½ÐÇÆÚ(Ö»ÔÊÐí1901-2099Äê) 
 320              @Èë¿Ú²ÎÊý£º   year,month,day£º¹«ÀúÄêÔÂÈÕ 
 321              @³ö¿Ú²ÎÊý£º   ÐÇÆÚºÅ        0 ~ 6   ->  ÖÜÈÕ ~ ÖÜÁù
 322              @±¸×¢ËµÃ÷£º   ÎÞ
 323          */
 324          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 325          static uint8_t get_week(uint16_t _year,uint8_t _month,uint8_t _day)
 326          {       
 327   1              uint16_t temp2;
 328   1              uint8_t yearH,yearL;
 329   1              
 330   1              yearH =_year/100;       yearL = _year%100; 
 331   1              
 332   1              if (yearH > 19) 
 333   1          {
 334   2              yearL += 100;// Èç¹ûÎª21ÊÀ¼Í,Äê·ÝÊý¼Ó100  
 335   2          }
 336   1              // Ëù¹ýÈòÄêÊýÖ»Ëã1900ÄêÖ®ºóµÄ  
 337   1              temp2 = yearL + yearL / 4;
 338   1              temp2 = temp2 % 7; 
 339   1              temp2 = temp2 + _day + table_week[_month - 1];
 340   1              if (yearL % 4 == 0 && _month < 3) 
 341   1          {
 342   2              temp2--;
 343   2          }
 344   1              return(temp2 % 7);
 345   1      }       
 346          
 347          
 348          /*--------------------------------------------------------------------------------------------------------
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 7   

             -----------------------------------*/
 349          /***@º¯ÊýÃû³Æ£º   set_rtc
 350              @º¯Êý¹¦ÄÜ£º   ÉèÖÃÈÕÀúÐÅÏ¢£¨½«±äÁ¿ÖÐµÄÖµÐ´Èë¼Ä´æÆ÷£©
 351              @Èë¿Ú²ÎÊý£º   ÎÞ
 352              @³ö¿Ú²ÎÊý£º   ÎÞ
 353              @±¸×¢ËµÃ÷£º   ÎÞ
 354          */
 355          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 356          void set_rtc(uint16_t s_year,uint8_t s_month,uint8_t s_day,uint8_t s_hour,uint8_t s_minute,uint8_t s_secon
             -d)
 357          {
 358   1              uint16_t rtc_day = 0;           
 359   1              uint16_t year_number = 1970;
 360   1              uint8_t  month_number = 0;
 361   1              uint8_t  s_week = 0;
 362   1              /*Í¨¹ýÒªÉèÖÃµÄ ÄêÔÂÈÕ ¼ÆËãÒªÐ´Èë RTCD ¼Ä´æÆ÷µÄÖµ*/
 363   1              for (; year_number < s_year; year_number++)
 364   1              {
 365   2                      if(is_leap_year(year_number)) 
 366   2              {
 367   3                  rtc_day += 366;
 368   3              }
 369   2                      else 
 370   2              {
 371   3                  rtc_day += 365;
 372   3              }     
 373   2              }       
 374   1      //      s_month -= 1;
 375   1              for (; month_number < s_month - 1; month_number++)      
 376   1              {
 377   2                      rtc_day += day_of_month[month_number];          
 378   2                      if(is_leap_year(s_year) && (month_number == 1)) //Èç¹ûÊÇÈòÄê£¬µÚ2¸öÔÂ
 379   2                      {
 380   3                  rtc_day += 1;                                                                                                                               //¶à¼ÓÒ»Ìì
 381   3              }       
 382   2              }
 383   1              rtc_day += s_day - 1 ;                                                                                                          //µÃµ½×ÜµÄÌìÊý  
 384   1              s_week = get_week(s_year,s_month,s_day);                                        //µÃµ½ÐÇÆÚºÅ
 385   1              if (s_week == 0) 
 386   1          {
 387   2              s_week = 7;
 388   2          }
 389   1              /************************************************/
 390   1              RTC_W_EN;                                                               //RTCÊ±ÖÓ¼Ä´æÆ÷Ð´Ê¹ÄÜ                                   
 391   1              RTCS = s_second;
 392   1              RTCM = s_minute;
 393   1              RTCH = (s_week << 5) | s_hour;                                                  //weekµÄµÍ3Î»´æ´¢ÔÚRTCHµÄ¸ß3Î»
 394   1                                                                                                                                                                                              //hour´æ´¢ÔÚRTCHµÄµÍ5Î» 
 395   1              RTCDH = (uint8_t)(rtc_day >> 8);
 396   1              RTCDL = (uint8_t)rtc_day;
 397   1      
 398   1              Delay_50us(1);
 399   1              RTC_W_DIS;                                                      //RTCÊ±ÖÓ¼Ä´æÆ÷Ð´½ûÖ¹
 400   1      }
 401          
 402          
 403          
 404          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 405          /***@º¯ÊýÃû³Æ£º   alarm_timeout_opera
 406              @º¯Êý¹¦ÄÜ£º   ÉèÖÃÈÕÀúÐÅÏ¢£¨½«±äÁ¿ÖÐµÄÖµÐ´Èë¼Ä´æÆ÷£©
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 8   

 407              @Èë¿Ú²ÎÊý£º   ÎÞ
 408              @³ö¿Ú²ÎÊý£º   ÎÞ
 409              @±¸×¢ËµÃ÷£º   ÎÞ
 410          */
 411          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 412          static void alarm_timeout_opera(uint8_t _alarm)
 413          {
 414   1              flag_current_alarmed = _alarm;          //
 415   1              flag_alarm_timeout = 1;                                         //ÄÖÖÓÊ±¼äµ½
 416   1              alarmed_time = 0;       
 417   1              
 418   1              alarm_ring_step = 0;                                                    
 419   1              alarm_ring_cycle = 2;
 420   1      
 421   1              alarm_shake_step = 0;                                                   
 422   1              alarm_shake_cycle = 2;          
 423   1      }
 424          
 425          
 426          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 427          /***@º¯ÊýÃû³Æ£º   enter_snooze
 428              @º¯Êý¹¦ÄÜ£º   ½øÈëÌ°Ë¯
 429              @Èë¿Ú²ÎÊý£º   ÎÞ
 430              @³ö¿Ú²ÎÊý£º   ÎÞ
 431              @±¸×¢ËµÃ÷£º   ÎÞ
 432          */
 433          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 434          
 435          void enter_snooze(void)
 436          {
 437   1              uint8_t snooze_minute_temp = 0, snooze_hour_temp = 0;
 438   1              
 439   1              flag_alarm_timeout = !flag_alarm_timeout;               //¹Ø±ÕÄÖÖÓ
 440   1              flag_enter_snooze = 1;                                                                                                  //½øÈëÌ°Ë¯
 441   1              flag_current_snooze = flag_current_alarmed;                     //¼ÇÂ¼µ±Ç°Ë¯ÃßµÄÊÇÄÄÒ»¸öÄÖÖÓ
 442   1      //      rtc_alarm[ALARM_SNOOZE].a_day = rtc_alarm[flag_current_alarmed].a_day;          //¼ÇÂ¼µ±Ç°Ë¯ÃßµÄÄÖÖÓµÄ¹¤×÷ÈÕÀàÐ
             -Í
 443   1              //ÉèÖÃÌ°Ë¯ÄÖÖÓ£ºÄÖÖÓÊ±¼ä = µ±Ç°Ê±¼ä + Ì°Ë¯Ê±¼ä (9·ÖÖÓ)                                                  
 444   1              snooze_minute_temp = RTCM + snooze_time;
 445   1              snooze_hour_temp = (RTCH & 0x1f);
 446   1              if (snooze_minute_temp >= 60)
 447   1              {
 448   2                      snooze_minute_temp -= 60;
 449   2                      snooze_hour_temp += 1; 
 450   2              }
 451   1              rtc_alarm[ALARM_SNOOZE].a_hour = snooze_hour_temp;
 452   1              rtc_alarm[ALARM_SNOOZE].a_minute = snooze_minute_temp;
 453   1              rtc_alarm[ALARM_SNOOZE].a_second = RTCS;        
 454   1      }
 455          
 456          
 457          
 458          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 459          /***@º¯ÊýÃû³Æ£º   snooze_alarm_test
 460              @º¯Êý¹¦ÄÜ£º   ²âÊÔÌ°Ë¯ÄÖÖÓ£¬Ã¿Ãë²âÊÔÒ»´Î
 461              @Èë¿Ú²ÎÊý£º   ÎÞ
 462              @³ö¿Ú²ÎÊý£º   ÎÞ
 463              @±¸×¢ËµÃ÷£º   ÎÞ
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 9   

 464          */
 465          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 466          void snooze_alarm_test(void)
 467          {
 468   1              if(flag_enter_snooze)                                                   //Èç¹û½øÈëµ½ Ì°Ë¯
 469   1              {
 470   2                      if((RTCH & 0x1f) == rtc_alarm[ALARM_SNOOZE].a_hour && RTCM == rtc_alarm[ALARM_SNOOZE].a_minute && RTCS =
             -= rtc_alarm[ALARM_SNOOZE].a_second)
 471   2                      {
 472   3                              alarm_timeout_opera(flag_current_snooze);
 473   3                      }
 474   2              }
 475   1      }
 476          
 477          
 478          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 479          /***@º¯ÊýÃû³Æ£º   alarm_test
 480              @º¯Êý¹¦ÄÜ£º   ÄÖÖÓ²âÊÔ£¬Ã¿·Ö²âÊÔÒ»´Î
 481              @Èë¿Ú²ÎÊý£º   ÎÞ
 482              @³ö¿Ú²ÎÊý£º   ÎÞ
 483              @±¸×¢ËµÃ÷£º   ÎÞ
 484          */
 485          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 486          void alarm_test(void)
 487          {
 488   1              if(lcd_mode == mode_clock)
 489   1              {
 490   2                      //------------------ ÄÖÖÓ1´¦Àí ------------                     
 491   2                      if(flag_alarm1_en)
 492   2                      {
 493   3                              if((RTCH & 0x1f) == rtc_alarm[ALARM_1].a_hour && RTCM == rtc_alarm[ALARM_1].a_minute)
 494   3                              {
 495   4                      //alarm_timeout_opera(ALARM_1);
 496   4      
 497   4                                      switch(rtc_alarm[ALARM_1].a_day)
 498   4                                      {
 499   5                                              case day_1_1:                                                                                                                           
 500   5                                                                              flag_alarm1_en = !flag_alarm1_en;               //¹Ø±ÕÄÖÖÓ
 501   5                                                                              alarm_timeout_opera(ALARM_1);
 502   5                                                                              break;
 503   5                                              case day_1_5:   
 504   5                                                                              if((RTCH >> 5 != 6) && (RTCH >> 5 != 7))
 505   5                                                                              {
 506   6                                                                                      alarm_timeout_opera(ALARM_1);                                                                   
 507   6                                                                              }
 508   5                                                                              break;
 509   5                                              case day_1_7:
 510   5                                                                              alarm_timeout_opera(ALARM_1);           
 511   5                                                                              break;
 512   5                                              case day_6_7:   
 513   5                                                                              if((RTCH >> 5 == 6) || (RTCH >> 5 == 7))
 514   5                                                                              {
 515   6                                                                                      alarm_timeout_opera(ALARM_1);                                                                   
 516   6                                                                              }
 517   5                                                                              break;
 518   5                          default:break;                
 519   5                                      }       
 520   4                              }
 521   3                      }       
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 10  

 522   2                      //------------------ ÄÖÖÓ2´¦Àí ------------                     
 523   2                      if(flag_alarm2_en)
 524   2                      {
 525   3                              if((RTCH & 0x1f) == rtc_alarm[ALARM_2].a_hour && RTCM == rtc_alarm[ALARM_2].a_minute)
 526   3                              {
 527   4                                //alarm_timeout_opera(ALARM_2);
 528   4                                      switch(rtc_alarm[ALARM_2].a_day)
 529   4                                      {
 530   5                                              case day_1_1:
 531   5                                                                              flag_alarm2_en = !flag_alarm2_en;               //¹Ø±ÕÄÖÖÓ
 532   5                                                                              alarm_timeout_opera(ALARM_2);
 533   5                                                                              break;
 534   5                                              case day_1_5:   
 535   5                                                                              if((RTCH >> 5 != 6) && (RTCH >> 5 != 7))
 536   5                                                                              {
 537   6                                                                                      alarm_timeout_opera(ALARM_2);                                                           
 538   6                                                                              }
 539   5                                                                              break;
 540   5                                              case day_1_7:
 541   5                                                                              alarm_timeout_opera(ALARM_2);
 542   5                                                                              break;
 543   5                                              case day_6_7:   
 544   5                                                                              if((RTCH >> 5 == 6) || (RTCH >> 5 == 7))
 545   5                                                                              {
 546   6                                                                                      alarm_timeout_opera(ALARM_2);                                                           
 547   6                                                                              }
 548   5                                                                              break;
 549   5                          default:break;                 
 550   5                                      }       
 551   4                              }
 552   3                      }       
 553   2              }
 554   1      }
 555          
 556          
 557          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 558          /***@º¯ÊýÃû³Æ£º   alarmed_time_test
 559              @º¯Êý¹¦ÄÜ£º   ²âÊÔÄÖÁåÏìÆð¾­¹ýµÄÊ±¼ä£¬Ã¿Ãë²âÊÔÒ»´Î
 560              @Èë¿Ú²ÎÊý£º   ÎÞ
 561              @³ö¿Ú²ÎÊý£º   ÎÞ
 562              @±¸×¢ËµÃ÷£º   ÎÞ
 563          */
 564          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 565          void alarmed_time_test(void)
 566          {
 567   1              //------------------ÄÖÖÓÏìÁåÊ±¼ä³¤¶È´¦Àí------------
 568   1              if (flag_alarm_timeout)
 569   1              {
 570   2                      if (++alarmed_time >= /*rtc_alarm[flag_current_alarmed].a_ringtime*/ALARM_TIME * 60)
 571   2                      {
 572   3                              flag_alarm_timeout = 0;
 573   3                  if(flag_enter_snooze)
 574   3                      {
 575   4                      flag_enter_snooze = !flag_enter_snooze;
 576   4                  }   
 577   3                      }
 578   2              }
 579   1      //      else
 580   1      //      {
 581   1      //              alarmed_time = 0;
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 11  

 582   1      //      }
 583   1      }
 584          
 585          
 586          
 587          
 588          /*********************************************************************************************************
             -************
 589          ¹¦      ÄÜ£º   10msÖÜÆÚµ÷ÓÃ
 590          ²Î      Êý£º
 591          ·µ»ØÖµ£º
 592          **********************************************************************************************************
             -***********/
 593          
 594          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 595          /***@º¯ÊýÃû³Æ£º   rtc_alarm_opera
 596              @º¯Êý¹¦ÄÜ£º   10msÖÜÆÚµ÷ÓÃ
 597              @Èë¿Ú²ÎÊý£º   ÎÞ
 598              @³ö¿Ú²ÎÊý£º   ÎÞ
 599              @±¸×¢ËµÃ÷£º   ÎÞ
 600          */
 601          /*--------------------------------------------------------------------------------------------------------
             -----------------------------------*/
 602          void rtc_alarm_opera(void) 
 603          {       
 604   1              static uint8_t changed = 0;
 605   1          if (lcd_mode != mode_test)
 606   1          {
 607   2              if (flag_dc_5v)
 608   2                  {
 609   3                      if (flag_alarm_timeout)         
 610   3                      {
 611   4                              flag_enter_snooze = 0;                                                          //Òþ²ØÌ°Ë¯·ûºÅ
 612   4                              if (!changed)                                                                                                   //-------µÚÒ»´Î½øÈëÄÖÁå
 613   4                              {
 614   5                                      changed = 1;                                                                                            //ÉèÖÃ±êÖ¾
 615   5                              }       
 616   4                              if (flag_alarm_style_shake)                                             //****ÄÖÖÓÊ±¼äµ½Ê± Õð¶¯µÄ²Ù×÷
 617   4                              {
 618   5                                      alarm_shake();                                                                                  //ÖÜÆÚµ÷ÓÃ              
 619   5                              }
 620   4                      
 621   4                              if (flag_alarm_style_ring)                                                      //****ÄÖÖÓÊ±¼äµ½Ê± ÁåÉùµÄ²Ù×÷
 622   4                              {
 623   5                                      alarm_tone();                                                                                           //ÖÜÆÚµ÷ÓÃ
 624   5                              }
 625   4                      }
 626   3                      else /*************** ÄÖÖÓÍê³É ********************/
 627   3                      {       
 628   4                              if (changed)
 629   4                              {
 630   5                                      changed = 0;
 631   5                                      motor_stop();                                   
 632   5                              }           
 633   4                      ring_stop();
 634   4                      }       
 635   3              }
 636   2          }
 637   1      }
 638          
 639          #if 0
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 12  

              void rtc_alarm_opera(void) 
              {       
                      static uint8_t changed = 0;
                  if (lcd_mode != mode_test)
                  {
                      spk_cmd_ing = 0;
                      alarm_tone();   
                      //send_ring_cmd(g_current_ring_vol_level);
                      //alarm_tone(); 
              
                      /*
                      if (flag_dc_5v)
                          {
                          alarm_tone();                               
                      }
                      */
                  }
              }
              #endif
 659          
 660          #if 0
              void rtc_alarm_opera(void) 
              {       
                      static uint8_t changed = 0;
                      
                      if (lcd_mode != mode_test)
                  {
                      if (flag_dc_5v)
                          {
                              if (flag_alarm_timeout)         
                              {
                              flag_enter_snooze = 0;                                                          //Òþ²ØÌ°Ë¯·ûºÅ
                                      if (!changed)                                                                                                   //-------µÚÒ»´Î½øÈëÄÖÁå
                                      {
                                              changed = 1;                                                                                            //ÉèÖÃ±êÖ¾
                                      }
                              if (flag_alarm_style_shake)                                             //****ÄÖÖÓÊ±¼äµ½Ê± Õð¶¯µÄ²Ù×÷
                                      {
                                               alarm_tone();          
                                      }
                          }
                          if (!flag_alarm_timeout)
                          {
                              if (changed)
                                      {
                                              changed = 0;
                                              motor_stop();                                   
                                      }
                                              
                              ring_stop();
                          }
                              }
                      }
              }
              #endif
 695          
 696          
 697          
 698          
 699          /*********************************************************************************************************
             -************
 700          ¹¦      ÄÜ£º
C51 COMPILER V9.60.0.0   RTC                                                               04/10/2021 13:15:03 PAGE 13  

 701          ²Î      Êý£º
 702          ·µ»ØÖµ£º
 703          **********************************************************************************************************
             -***********/
 704          //void factory_set(void)
 705          //{
 706          //      u8 i;
 707          //      flag_24hours_en = 1;                                            //24Ð¡Ê±ÖÆ
 708          //      set_rtc(factory.st_year,                                //ÉèÖÃ³ö³§Ê±¼ä
 709          //                                      factory.st_month,
 710          //                                      factory.st_day,
 711          //                                      factory.st_hour,
 712          //                                      factory.st_minute,
 713          //                                      factory.st_second);                     
 714          //      get_calendar(); 
 715          //      
 716          //      for(i = 0; i < 2; i++)                                  //ÉèÖÃÄÖÖÓ²ÎÊý
 717          //      {
 718          //              rtc_alarm[i].a_ringtime = 10;                   //ÄÖÁåÊ±³¤£º10·ÖÖÓ
 719          //              rtc_alarm[i].a_day = day_1_7;                   //ÄÖÁåÈÕÆÚ£ºÃ¿Ìì
 720          //              rtc_alarm[i].a_hour = 7;                                        //ÄÖÖÓÊ±£º 7
 721          //              rtc_alarm[i].a_minute = 0;
 722          //              rtc_alarm[i].a_second = 0;      
 723          //      }
 724          //      
 725          //      snooze_time = 9;                                                                //Ì°Ë¯Ê±³¤£º 9·ÖÖÓ      
 726          //}
 727          
 728          
 729          
 730          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1445    ----
   CONSTANT SIZE    =     24    ----
   XDATA SIZE       =     43      21
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
